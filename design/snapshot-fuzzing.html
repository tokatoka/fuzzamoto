<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Snapshot Fuzzing - Fuzzamoto Documentation</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="../favicon.svg">
                        <link rel="shortcut icon" href="../favicon.png">
                <link rel="stylesheet" href="../css/variables.css">
        <link rel="stylesheet" href="../css/general.css">
        <link rel="stylesheet" href="../css/chrome.css">
                <link rel="stylesheet" href="../css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="../FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="../fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="../highlight.css">
        <link rel="stylesheet" href="../tomorrow-night.css">
        <link rel="stylesheet" href="../ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "../";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded affix "><a href="../index.html">Introduction</a></li><li class="chapter-item expanded affix "><li class="part-title">Design</li><li class="chapter-item expanded "><a href="../design/snapshot-fuzzing.html" class="active"><strong aria-hidden="true">1.</strong> Snapshot Fuzzing</a></li><li class="chapter-item expanded "><a href="../design/scenarios.html"><strong aria-hidden="true">2.</strong> Scenarios</a></li><li class="chapter-item expanded "><a href="../design/ir.html"><strong aria-hidden="true">3.</strong> Intermediate Representation</a></li><li class="chapter-item expanded affix "><li class="part-title">Usage</li><li class="chapter-item expanded "><a href="../usage/aflpp.html"><strong aria-hidden="true">4.</strong> Fuzzing with AFL++</a></li><li class="chapter-item expanded "><a href="../usage/libafl.html"><strong aria-hidden="true">5.</strong> Fuzzing with fuzzamoto-libafl</a></li><li class="chapter-item expanded "><a href="../usage/reproducing.html"><strong aria-hidden="true">6.</strong> Reproducing Testcases</a></li><li class="chapter-item expanded "><a href="../usage/target-patches.html"><strong aria-hidden="true">7.</strong> Custom Target Patches</a></li><li class="chapter-item expanded "><a href="../usage/coverage.html"><strong aria-hidden="true">8.</strong> Coverage Reports</a></li><li class="chapter-item expanded "><a href="../usage/requirements.html"><strong aria-hidden="true">9.</strong> System Requirements</a></li><li class="chapter-item expanded "><a href="../usage/cli.html"><strong aria-hidden="true">10.</strong> CLI Reference</a></li><li class="chapter-item expanded affix "><li class="part-title">Contributing</li><li class="chapter-item expanded "><a href="../contributing/integrating.html"><strong aria-hidden="true">11.</strong> Integrating New Targets</a></li><li class="chapter-item expanded "><a href="../contributing/scenarios.html"><strong aria-hidden="true">12.</strong> Writing New Scenarios</a></li><li class="chapter-item expanded "><a href="../contributing/ir.html"><strong aria-hidden="true">13.</strong> Extending Fuzzamoto IR</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Fuzzamoto Documentation</h1>

                    <div class="right-buttons">
                                                <a href="../print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="snapshot-fuzzing"><a class="header" href="#snapshot-fuzzing">Snapshot Fuzzing</a></h1>
<p>To achieve deterministic and performant fuzzing of one or more full node
instances, snapshot fuzzing is used. With snapshot fuzzing, testcases are
executed inside a special virtual machine that has the ability to take a
snapshot of itself (CPU registers, memory, disk, other devices, ...) and also
to reset itself quickly to that snapshot.</p>
<p>The rough architecture when fuzzing with fuzzamoto looks as follows:</p>
<pre><code>                       Report bug                              
                           ▲                                   
                           │                                   
                           │                                   
                          Yes                                  
                           │                                   
                           │                                   
       ┌─────────────────►Bug?───────────────────────────────┐ 
       │                                                     │ 
       │                                                     │ 
       │                                                     │ 
┌──────┼──────────── Virtual Machine ───────────────────┐    │ 
│      │                                                │    │ 
│ ┌────┼─────┐                            ┌───────────┐ │    │ 
│ │ Scenario │◄───────p2p/rpc/...────────►│ Full Node │ │    No
│ └────▲─────┘                            └───────────┘ │    │ 
│      │                                                │    │ 
└──────┼────────────────────────────────────────────────┘    │ 
       │                                                     │ 
       │                                                     │ 
       │                                                     │ 
       └─────────Generate/Mutate testcase◄───────────────────┘ 
</code></pre>
<p>Inside the VM, a <a href="./scenarios.html">scenario</a> runs that controls snapshot
creation and receives inputs from the fuzzer to execute against the target(s).
If a bug is detected, the scenario reports it to the fuzzer. If no crash is
detected and the scenario finishes the execution of a testcase, it tells the
fuzzer to reset the VM and provide another testcase.</p>
<h2 id="backends"><a class="header" href="#backends">Backends</a></h2>
<p>Currently, snapshot fuzzing support is only implemented for
<a href="https://nyx-fuzz.com"><code>Nyx</code></a> but other backends could also be supported in the
future.</p>
<p>The
<a href="https://github.com/dergoegge/fuzzamoto/tree/master/fuzzamoto-nyx-sys"><code>fuzzamoto-nyx-sys</code></a>
crate provides rust bindings to a nyx agent implementation written in C. The
agent provides the interface for scenarios to communicate with the fuzzer
through the Nyx hypercall API. The agent provides the following functionality:</p>
<ul>
<li>Taking a VM snapshot &amp; receiving the next input from the fuzzer</li>
<li>Reporting a crash to the fuzzer</li>
<li>Resetting the VM to the snapshot</li>
<li>Instructing the fuzzer to ignore the current testcase</li>
<li>Dumping files to the host machine</li>
</ul>
<p>The crate also comes with a <code>LD_PRELOAD</code>able crash handler that reports
application aborts directly to Nyx (See
<a href="https://github.com/dergoegge/fuzzamoto/tree/master/fuzzamoto-nyx-sys/src/nyx-crash-handler.c"><code>nyx-crash-handler.c</code></a>).</p>
<h3 id="alternative-backends"><a class="header" href="#alternative-backends">Alternative Backends</a></h3>
<p>In the future, using
<a href="https://github.com/AFLplusplus/LibAFL/tree/main/libafl_qemu"><code>libafl_qemu</code></a>
and its full system capabilities would enable fuzzing on and of more
architectures (Nyx only supports x86 at this time) as well enable fuzzing on
non-bare metal hardware.</p>
<h2 id="coverage-feedback"><a class="header" href="#coverage-feedback">Coverage Feedback</a></h2>
<p>Coverage data is collected using compile time instrumentation and communicated
to the fuzzer using Nyx's compile-time instrumentation mode. Currently, only
AFL++ coverage instrumentation is supported, which necessitates that targets
are build with <code>afl-clang-{fast,lto}</code>.</p>
<p>Upon initialization, the Nyx agent creates a shared memory region large enough
to fit the target's coverage map. The size of the map is previously determined
by executing the target binary with the <code>AFL_DUMP_MAP_SIZE=1</code> environment
variable (see
<a href="https://github.com/dergoegge/fuzzamoto/tree/master/fuzzamoto-nyx-sys/build.rs"><code>fuzzamoto-nyx-sys/build.rs</code></a>).
The agent then sets <code>__AFL_SHM_ID</code> and <code>AFL_MAP_SIZE</code> environment variables
(recognized by AFL++'s instrumentation) to the shared memory region's id and
size, respectively. It also informs Nyx of the address of the shared region,
which in turn is communicated to the fuzzer for feedback evaluation. Once the
target is executed, it writes the coverage data to the shared memory region.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="../index.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="../design/scenarios.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="../index.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="../design/scenarios.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="../highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="../book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
